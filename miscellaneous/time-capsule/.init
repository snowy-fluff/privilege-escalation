#!/usr/local/bin/python

import hashlib
import os
import random
import stat
import string
from pathlib import Path

ROOT = Path("/challenge")
LENGTH = 2**6

if __name__ == "__main__":
    (ROOT / ".init").unlink()

    for root, dirs, files in os.walk(str(ROOT), topdown=True, followlinks=True):
        for name in files:
            p = Path(root) / name
            try:
                if stat.S_ISREG(os.stat(p).st_mode):
                    os.chmod(p, 0o444)
            except Exception:
                continue

    rnd = random.Random(
        int.from_bytes(
            hashlib.sha256(Path("/flag").read_text().strip().encode()).digest(),
            "big",
        )
    )
    secret = "".join(
        rnd.choice(string.ascii_letters + string.digits) for _ in range(LENGTH)
    )

    try:
        old_umask = os.umask(0o377)

        with open(ROOT / ".secret", "w", encoding="utf-8") as f:
            f.write(secret)
            f.flush()
            os.fsync(f.fileno())
    finally:
        os.umask(old_umask)
        (ROOT / "shell").chmod(0o4555)
