#!/usr/local/bin/python

import hashlib
import os
import random
import stat
import string

ROOT = "/challenge"
LENGTH = 2**6

if __name__ == "__main__":
    try:
        os.remove(os.path.join(ROOT, ".init"))
    except FileNotFoundError:
        pass

    for root, dirs, files in os.walk(ROOT, topdown=True, followlinks=True):
        for name in files:
            p = os.path.join(root, name)
            try:
                st = os.stat(p)
                if stat.S_ISREG(st.st_mode):
                    os.chmod(p, 0o444)
            except Exception:
                continue

    rnd = random.Random(
        int.from_bytes(
            hashlib.sha256(
                open("/flag", "r", encoding="utf-8").read().strip().encode()
            ).digest(),
            "big",
        )
    )
    secret = "".join(
        rnd.choice(string.ascii_letters + string.digits) for _ in range(LENGTH)
    )

    try:
        old_umask = os.umask(0o377)
        with open(os.path.join(ROOT, ".secret"), "w", encoding="utf-8") as f:
            f.write(secret)
            f.flush()
            os.fsync(f.fileno())
    finally:
        os.umask(old_umask)
        os.chmod("/challenge/shell", 0o444)
