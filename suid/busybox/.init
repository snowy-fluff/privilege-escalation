#!/bin/bash

rm /challenge/.init
find -L /challenge -type f -exec chmod 0444 {} +

cat <<'EOF' >/etc/busybox.conf
[SUID]
[ = ssx root.0
[[ = ssx root.0
acpid = ssx root.0
adjtimex = ssx root.0
ar = ssx root.0
arch = ssx root.0
arp = ssx root.0
arping = ssx root.0
ascii = ssx root.0
ash = ssx root.0
awk = ssx root.0
base64 = ssx root.0
basename = ssx root.0
bc = ssx root.0
blkdiscard = ssx root.0
blkid = ssx root.0
blockdev = ssx root.0
brctl = ssx root.0
bunzip2 = ssx root.0
bzcat = ssx root.0
bzip2 = ssx root.0
cal = ssx root.0
cat = ssx root.0
chgrp = ssx root.0
chmod = ssx root.0
chown = ssx root.0
chpasswd = ssx root.0
chroot = ssx root.0
chvt = ssx root.0
clear = ssx root.0
cmp = ssx root.0
cp = ssx root.0
cpio = ssx root.0
crc32 = ssx root.0
crond = ssx root.0
crontab = ssx root.0
cttyhack = ssx root.0
cut = ssx root.0
date = ssx root.0
dc = ssx root.0
dd = ssx root.0
deallocvt = ssx root.0
depmod = ssx root.0
devmem = ssx root.0
df = ssx root.0
diff = ssx root.0
dirname = ssx root.0
dmesg = ssx root.0
dnsdomainname = ssx root.0
dos2unix = ssx root.0
dpkg = ssx root.0
dpkg-deb = ssx root.0
du = ssx root.0
dumpkmap = ssx root.0
dumpleases = ssx root.0
echo = ssx root.0
ed = ssx root.0
egrep = ssx root.0
env = ssx root.0
expand = ssx root.0
expr = ssx root.0
factor = ssx root.0
fallocate = ssx root.0
false = ssx root.0
fatattr = ssx root.0
fdisk = ssx root.0
fgrep = ssx root.0
find = ssx root.0
findfs = ssx root.0
fold = ssx root.0
free = ssx root.0
freeramdisk = ssx root.0
fsfreeze = ssx root.0
fstrim = ssx root.0
ftpget = ssx root.0
ftpput = ssx root.0
getopt = ssx root.0
getty = ssx root.0
grep = ssx root.0
groups = ssx root.0
gunzip = ssx root.0
gzip = ssx root.0
halt = ssx root.0
head = ssx root.0
hexdump = ssx root.0
hostid = ssx root.0
hostname = ssx root.0
httpd = ssx root.0
hwclock = ssx root.0
i2cdetect = ssx root.0
i2cdump = ssx root.0
i2cget = ssx root.0
i2cset = ssx root.0
i2ctransfer = ssx root.0
id = ssx root.0
ifconfig = ssx root.0
ifdown = ssx root.0
ifup = ssx root.0
init = ssx root.0
insmod = ssx root.0
ionice = ssx root.0
ip = ssx root.0
ipcalc = ssx root.0
kill = ssx root.0
killall = ssx root.0
klogd = ssx root.0
last = ssx root.0
less = ssx root.0
link = ssx root.0
linux32 = ssx root.0
linux64 = ssx root.0
linuxrc = ssx root.0
ln = ssx root.0
loadfont = ssx root.0
loadkmap = ssx root.0
logger = ssx root.0
login = ssx root.0
logname = ssx root.0
logread = ssx root.0
losetup = ssx root.0
ls = ssx root.0
lsmod = ssx root.0
lsscsi = ssx root.0
lzcat = ssx root.0
lzma = ssx root.0
lzop = ssx root.0
md5sum = ssx root.0
mdev = ssx root.0
microcom = ssx root.0
mim = ssx root.0
mkdir = ssx root.0
mkdosfs = ssx root.0
mke2fs = ssx root.0
mkfifo = ssx root.0
mknod = ssx root.0
mkpasswd = ssx root.0
mkswap = ssx root.0
mktemp = ssx root.0
modinfo = ssx root.0
modprobe = ssx root.0
more = ssx root.0
mount = ssx root.0
mt = ssx root.0
mv = ssx root.0
nameif = ssx root.0
nbd-client = ssx root.0
nc = ssx root.0
netstat = ssx root.0
nl = ssx root.0
nologin = ssx root.0
nproc = ssx root.0
nsenter = ssx root.0
nslookup = ssx root.0
nuke = ssx root.0
od = ssx root.0
openvt = ssx root.0
partprobe = ssx root.0
passwd = ssx root.0
paste = ssx root.0
patch = ssx root.0
pidof = ssx root.0
ping = ssx root.0
ping6 = ssx root.0
pivot_root = ssx root.0
poweroff = ssx root.0
printf = ssx root.0
ps = ssx root.0
pwd = ssx root.0
rdate = ssx root.0
readlink = ssx root.0
realpath = ssx root.0
reboot = ssx root.0
renice = ssx root.0
reset = ssx root.0
resume = ssx root.0
rev = ssx root.0
rm = ssx root.0
rmdir = ssx root.0
rmmod = ssx root.0
route = ssx root.0
rpm = ssx root.0
rpm2cpio = ssx root.0
run-init = ssx root.0
run-parts = ssx root.0
sed = ssx root.0
seq = ssx root.0
setkeycodes = ssx root.0
setpriv = ssx root.0
setsid = ssx root.0
sh = ssx root.0
sha1sum = ssx root.0
sha256sum = ssx root.0
sha3sum = ssx root.0
sha512sum = ssx root.0
shred = ssx root.0
shuf = ssx root.0
sleep = ssx root.0
sort = ssx root.0
ssl_client = ssx root.0
start-stop-daemon = ssx root.0
stat = ssx root.0
strings = ssx root.0
stty = ssx root.0
su = ssx root.0
sulogin = ssx root.0
svc = ssx root.0
svok = ssx root.0
swapoff = ssx root.0
swapon = ssx root.0
switch_root = ssx root.0
sync = ssx root.0
sysctl = ssx root.0
syslogd = ssx root.0
tac = ssx root.0
tail = ssx root.0
tar = ssx root.0
taskset = ssx root.0
tc = ssx root.0
tee = ssx root.0
telnet = ssx root.0
test = ssx root.0
tftp = ssx root.0
time = ssx root.0
timeout = ssx root.0
top = ssx root.0
touch = ssx root.0
tr = ssx root.0
traceroute = ssx root.0
traceroute6 = ssx root.0
true = ssx root.0
truncate = ssx root.0
ts = ssx root.0
tty = ssx root.0
tunctl = ssx root.0
ubirename = ssx root.0
udhcpc = ssx root.0
udhcpc6 = ssx root.0
udhcpd = ssx root.0
uevent = ssx root.0
umount = ssx root.0
uname = ssx root.0
uncompress = ssx root.0
unexpand = ssx root.0
uniq = ssx root.0
unix2dos = ssx root.0
unlink = ssx root.0
unlzma = ssx root.0
unshare = ssx root.0
unxz = ssx root.0
unzip = ssx root.0
uptime = ssx root.0
usleep = ssx root.0
uudecode = ssx root.0
uuencode = ssx root.0
vconfig = ssx root.0
vi = ssx root.0
w = ssx root.0
watch = ssx root.0
watchdog = ssx root.0
wc = ssx root.0
wget = ssx root.0
which = ssx root.0
who = ssx root.0
whoami = ssx root.0
xargs = ssx root.0
xxd = ssx root.0
xz = ssx root.0
xzcat = ssx root.0
yes = ssx root.0
zcat = ssx root.0
EOF

chown 0:0 /etc/busybox.conf
chmod 600 /etc/busybox.conf

mkdir -p /challenge/bin
ln -sf /usr/bin/busybox /challenge/bin/busybox

chmod u+s /usr/bin/busybox
