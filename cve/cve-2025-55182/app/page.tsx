"use client";

import { FormEvent, useCallback, useEffect, useState } from "react";

type Post = {
    id: number;
    content: string;
    author: string;
    published: boolean;
};

type Mode = "home" | "login" | "register";

export default function HomePage() {
    const [mode, setMode] = useState<Mode>("home");
    const [username, setUsername] = useState<string | null>(null);
    const [token, setToken] = useState<string | null>(() => {
        if (typeof window === "undefined") return null;
        return localStorage.getItem("pwnpost_token");
    });
    const [posts, setPosts] = useState<Post[]>([]);
    const [loading, setLoading] = useState<boolean>(() => {
        if (typeof window === "undefined") return true;
        return Boolean(localStorage.getItem("pwnpost_token"));
    });
    const [draftContent, setDraftContent] = useState("");
    const [publishNow, setPublishNow] = useState(false);
    const [authUsername, setAuthUsername] = useState("");
    const [authPassword, setAuthPassword] = useState("");
    const [error, setError] = useState<string | null>(null);
    const [notice, setNotice] = useState<string | null>(null);
    const apiUrl = (path: string) => {
        const envPrefix = process.env.NEXT_PUBLIC_BASE_PATH;
        const detectedPrefix =
            typeof window !== "undefined"
                ? window.location.pathname.match(/^\/workspace\/[^/]+/)?.[0]
                : "";
        const prefix = (envPrefix || detectedPrefix || "").replace(/\/$/, "");
        return `${prefix}${path}`;
    };

    const persistToken = useCallback((value: string | null) => {
        if (typeof window === "undefined") return;
        if (value) {
            localStorage.setItem("pwnpost_token", value);
        } else {
            localStorage.removeItem("pwnpost_token");
        }
    }, []);

    const refreshSession = useCallback(
        async (maybeToken?: string) => {
            setLoading(true);
            setError(null);
            const res = await fetch(apiUrl("/api/session"), {
                headers: maybeToken
                    ? {
                          Authorization: `Bearer ${maybeToken}`,
                      }
                    : undefined,
            });
            const data = await res.json();

            if (data.username) {
                setUsername(data.username);
                setPosts(data.posts || []);
                if (maybeToken) {
                    setToken(maybeToken);
                    persistToken(maybeToken);
                }
            } else {
                setUsername(null);
                setPosts([]);
                setToken(null);
                persistToken(null);
            }
            setLoading(false);
        },
        [persistToken]
    );

    useEffect(() => {
        if (token) {
            // Bootstraps the JWT session on load; intentional state sync in effect.
            // eslint-disable-next-line react-hooks/set-state-in-effect
            refreshSession(token);
        } else {
            setLoading(false);
        }
    }, [refreshSession, token]);

    useEffect(() => {
        if (!notice) return;
        const timer = setTimeout(() => setNotice(null), 3000);
        return () => clearTimeout(timer);
    }, [notice]);

    const handleAuth = async (
        endpoint: "login" | "register",
        event?: FormEvent
    ) => {
        event?.preventDefault();
        setError(null);
        setNotice(null);
        const res = await fetch(apiUrl(`/api/auth/${endpoint}`), {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                username: authUsername,
                password: authPassword,
            }),
        });

        const data = await res.json();
        if (!res.ok) {
            setError(data.error || "Something went wrong");
            return;
        }

        setToken(data.token);
        setUsername(data.username);
        persistToken(data.token);
        setMode("home");
        setAuthPassword("");
        setNotice(`Signed in as ${data.username}`);
        await refreshSession(data.token);
    };

    const handleDraft = async (event: FormEvent) => {
        event.preventDefault();
        if (!token) {
            setError("Log in first!");
            return;
        }
        setError(null);
        setNotice(null);

        const res = await fetch(apiUrl("/api/posts/draft"), {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
                content: draftContent,
                publish: publishNow,
            }),
        });

        const data = await res.json();
        if (!res.ok) {
            setError(data.error || "Failed to save draft");
            return;
        }

        setDraftContent("");
        setPublishNow(false);
        setNotice(publishNow ? "Published your latest post" : "Draft saved");
        await refreshSession(token);
    };

    const handlePublish = async () => {
        if (!token) {
            setError("Log in first!");
            return;
        }
        setError(null);
        setNotice(null);

        const res = await fetch(apiUrl("/api/posts/publish"), {
            method: "POST",
            headers: {
                Authorization: `Bearer ${token}`,
            },
        });
        const data = await res.json();
        if (!res.ok) {
            setError(data.error || "Could not publish drafts");
            return;
        }
        setNotice("Published all your drafts");
        await refreshSession(token);
    };

    const handleLogout = () => {
        setUsername(null);
        setToken(null);
        setPosts([]);
        persistToken(null);
        setNotice("Logged out");
        setMode("home");
    };

    const renderPostContent = (post: Post) => {
        if (post.author === username) {
            return (
                <div
                    dangerouslySetInnerHTML={{
                        __html: post.content || "(empty post)",
                    }}
                />
            );
        }

        if (username === "admin") {
            return <b>NON-ADMIN POST HIDDEN FOR SAFETY</b>;
        }

        if (post.published) {
            return (
                <div
                    dangerouslySetInnerHTML={{
                        __html: post.content || "(empty post)",
                    }}
                />
            );
        }

        return (
            <>
                <div className="muted">(Draft, first 12 characters)</div>
                <div
                    dangerouslySetInnerHTML={{
                        __html: (post.content || "").slice(0, 12),
                    }}
                />
            </>
        );
    };

    const renderAuthForm = (title: string, action: "login" | "register") => (
        <div className="card">
            <h2>{title}</h2>
            <form onSubmit={(e) => handleAuth(action, e)}>
                <label htmlFor={`${action}-username`}>Username</label>
                <input
                    id={`${action}-username`}
                    type="text"
                    name="username"
                    placeholder="Username"
                    value={authUsername}
                    onChange={(e) => setAuthUsername(e.target.value)}
                    autoFocus
                />
                <label htmlFor={`${action}-password`}>Password</label>
                <input
                    id={`${action}-password`}
                    type="password"
                    name="password"
                    placeholder="Password"
                    value={authPassword}
                    onChange={(e) => setAuthPassword(e.target.value)}
                />
                <div className="actions auth-actions">
                    <button
                        className="btn"
                        type="submit"
                        name="submit"
                        value={action}
                    >
                        {action === "login" ? "Log in" : "Register"}
                    </button>
                    <button
                        className="btn ghost"
                        type="button"
                        onClick={() =>
                            setMode(action === "login" ? "register" : "login")
                        }
                    >
                        {action === "login"
                            ? "Need an account?"
                            : "I already have an account"}
                    </button>
                </div>
            </form>
        </div>
    );

    return (
        <div className="shell">
            <div className="brand">
                <h1>pwnpost</h1>
            </div>
            <hr />

            {(error || notice) && (
                <div className="status-row">
                    {error ? <div className="toast error">{error}</div> : null}
                    {notice ? <div className="toast">{notice}</div> : null}
                </div>
            )}

            {loading ? (
                <div className="card">
                    <div className="muted">Loading sessionâ€¦</div>
                </div>
            ) : username ? (
                <>
                    <div className="card">
                        <div className="actions top-space">
                            <span className="pill">
                                Signed in as <b>{username}</b>
                            </span>
                            <button
                                className="btn ghost push-right"
                                onClick={handleLogout}
                            >
                                Logout
                            </button>
                        </div>
                        <form onSubmit={handleDraft}>
                            <label htmlFor="content">Post</label>
                            <textarea
                                id="content"
                                name="content"
                                placeholder="Write something!"
                                value={draftContent}
                                onChange={(e) =>
                                    setDraftContent(e.target.value)
                                }
                            />
                            <div className="actions">
                                <button className="btn" type="submit">
                                    Save
                                </button>
                                <label className="checkbox">
                                    Publish now
                                    <input
                                        type="checkbox"
                                        name="publish"
                                        checked={publishNow}
                                        onChange={(e) =>
                                            setPublishNow(e.target.checked)
                                        }
                                    />
                                </label>
                                <button
                                    className="btn ghost push-right"
                                    type="button"
                                    onClick={handlePublish}
                                >
                                    Publish All Drafts
                                </button>
                            </div>
                        </form>
                    </div>

                    <div className="grid">
                        {posts && posts.length ? (
                            posts.map((post) => (
                                <div className="post" key={post.id}>
                                    <h3>{post.author}</h3>
                                    {renderPostContent(post)}
                                </div>
                            ))
                        ) : (
                            <div className="card">
                                <div className="muted">
                                    No posts yet. Draft something!
                                </div>
                            </div>
                        )}
                    </div>
                </>
            ) : (
                <>
                    {mode === "home" ? (
                        <div className="card hero">
                            <h2>Welcome to pwnpost</h2>
                            <div className="actions">
                                <button
                                    className="btn"
                                    onClick={() => setMode("login")}
                                >
                                    Log in
                                </button>
                                <button
                                    className="btn ghost"
                                    onClick={() => setMode("register")}
                                >
                                    Register
                                </button>
                            </div>
                        </div>
                    ) : null}
                    {mode === "login" &&
                        renderAuthForm("Welcome back", "login")}
                    {mode === "register" &&
                        renderAuthForm("Create your account", "register")}
                </>
            )}
        </div>
    );
}
