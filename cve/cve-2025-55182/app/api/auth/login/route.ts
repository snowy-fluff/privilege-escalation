import { NextResponse } from "next/server";
import { signToken } from "../../../lib/auth";
import { findUser, hashPassword } from "../../../lib/db";

export const runtime = "nodejs";

export async function POST(request: Request) {
    const { username: rawUsername, password } = await request.json();
    const username = (rawUsername || "").trim();

    if (!username) {
        return NextResponse.json(
            { error: "Missing `username` field" },
            { status: 400 }
        );
    }
    if (!password) {
        return NextResponse.json(
            { error: "Missing `password` field" },
            { status: 400 }
        );
    }

    const user = findUser(username);
    if (!user || user.password !== hashPassword(password)) {
        return NextResponse.json(
            { error: "Invalid username or password" },
            { status: 403 }
        );
    }

    return NextResponse.json({
        token: signToken(username),
        username,
    });
}
