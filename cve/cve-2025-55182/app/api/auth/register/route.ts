import { NextResponse } from "next/server";
import { signToken } from "../../../lib/auth";
import { createUser, findUser } from "../../../lib/db";

export const runtime = "nodejs";

export async function POST(request: Request) {
    const { username: rawUsername, password } = await request.json();
    const username = (rawUsername || "").trim();

    if (!username) {
        return NextResponse.json(
            { error: "Missing `username` field" },
            { status: 400 }
        );
    }
    if (!password) {
        return NextResponse.json(
            { error: "Missing `password` field" },
            { status: 400 }
        );
    }
    if (username === "admin") {
        return NextResponse.json(
            { error: "That username is reserved" },
            { status: 400 }
        );
    }

    if (findUser(username)) {
        return NextResponse.json(
            { error: "That username is already taken" },
            { status: 400 }
        );
    }

    createUser(username, password);
    return NextResponse.json({
        token: signToken(username),
        username,
    });
}
