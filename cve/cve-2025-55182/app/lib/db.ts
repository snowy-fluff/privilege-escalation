import Database from "better-sqlite3";
import crypto from "crypto";
import fs from "fs";
import os from "os";
import path from "path";

export type PostRecord = {
    id: number;
    content: string;
    author: string;
    published: boolean;
};
export type UserRecord = {
    username: string;
    password: string;
};

const tempDir = fs.mkdtempSync(path.join(os.tmpdir(), "pwnpost-"));
const dbPath = path.join(tempDir, "pwnpost.db");
const db = new Database(dbPath);

const flag =
    (() => {
        try {
            return fs.readFileSync("/flag", "utf8").trim();
        } catch {
            return "pwn.college{fake_flag}";
        }
    })() || "pwn.college{fake_flag}";

export const hashPassword = (password: string): string =>
    crypto.createHash("sha3-512").update(password).digest("hex");

const seed = () => {
    db.prepare(
        `CREATE TABLE IF NOT EXISTS users (username TEXT PRIMARY KEY, password TEXT NOT NULL)`
    ).run();
    db.prepare(
        `CREATE TABLE IF NOT EXISTS posts (content TEXT NOT NULL, author TEXT NOT NULL, published INTEGER NOT NULL DEFAULT 0)`
    ).run();

    const adminExists = db
        .prepare("SELECT 1 FROM users WHERE username = ?")
        .get("admin");
    if (!adminExists) {
        db.prepare("INSERT INTO users (username, password) VALUES (?, ?)").run(
            "admin",
            hashPassword(flag)
        );
    }

    const guestExists = db
        .prepare("SELECT 1 FROM users WHERE username = ?")
        .get("guest");
    if (!guestExists) {
        db.prepare("INSERT INTO users (username, password) VALUES (?, ?)").run(
            "guest",
            hashPassword("password")
        );
    }

    const hackerExists = db
        .prepare("SELECT 1 FROM users WHERE username = ?")
        .get("hacker");
    if (!hackerExists) {
        db.prepare("INSERT INTO users (username, password) VALUES (?, ?)").run(
            "hacker",
            hashPassword("1337")
        );
    }

    const adminPostExists = db
        .prepare("SELECT 1 FROM posts WHERE author = ? LIMIT 1")
        .get("admin");
    if (!adminPostExists) {
        db.prepare(
            "INSERT INTO posts (content, author, published) VALUES (?, ?, ?)"
        ).run(flag, "admin", 0);
    }
};

seed();

export const findUser = (username: string): UserRecord | undefined => {
    const row = db
        .prepare("SELECT username, password FROM users WHERE username = ?")
        .get(username) as UserRecord | undefined;
    return row;
};

export const createUser = (username: string, password: string) => {
    db.prepare("INSERT INTO users (username, password) VALUES (?, ?)").run(
        username,
        hashPassword(password)
    );
};

export const getPosts = (): PostRecord[] => {
    const rows = db
        .prepare(
            "SELECT rowid as id, content, author, published FROM posts ORDER BY rowid DESC"
        )
        .all() as Array<{
        id: number;
        content: string;
        author: string;
        published: number;
    }>;

    return rows.map((row) => ({
        id: row.id,
        content: row.content,
        author: row.author,
        published: Boolean(row.published),
    }));
};

export const createPost = (
    content: string,
    author: string,
    publish: boolean
) => {
    db.prepare(
        "INSERT INTO posts (content, author, published) VALUES (?, ?, ?)"
    ).run(content, author, publish ? 1 : 0);
};

export const publishAll = (author: string) => {
    db.prepare("UPDATE posts SET published = 1 WHERE author = ?").run(author);
};
