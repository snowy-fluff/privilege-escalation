import crypto from "crypto";
import jwt from "jsonwebtoken";

const JWT_SECRET =
    process.env.JWT_SECRET || crypto.randomBytes(64).toString("hex");

type TokenPayload = {
    username: string;
};

export const signToken = (username: string) =>
    jwt.sign({ username }, JWT_SECRET, { expiresIn: "12h" });

export const verifyToken = (token?: string | null): string | null => {
    if (!token) return null;
    try {
        const decoded = jwt.verify(token, JWT_SECRET) as TokenPayload;
        return decoded.username;
    } catch {
        return null;
    }
};

export const extractToken = (request: Request) => {
    const header = request.headers.get("authorization") || "";
    if (header.toLowerCase().startsWith("bearer ")) {
        return header.slice(7).trim();
    }
    return null;
};
